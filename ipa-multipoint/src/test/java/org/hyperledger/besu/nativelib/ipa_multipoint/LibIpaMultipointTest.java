/*
 * Copyright Besu Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 */
package org.hyperledger.besu.nativelib.ipa_multipoint;

import org.apache.tuweni.bytes.MutableBytes;
import org.junit.jupiter.api.Test;
import static org.assertj.core.api.Assertions.*;

import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.hyperledger.besu.nativelib.ipamultipoint.LibIpaMultipoint;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.List;



public class LibIpaMultipointTest {

    @Test
    public void testCallLibrary() {
        Bytes32 input = Bytes32.fromHexString("0x0cfe0000");
        Bytes32 result = Bytes32.wrap(LibIpaMultipoint.commit(input.toArray()));
        Bytes32 expected = Bytes32.fromHexString("0x11169fb6b9dab0b5984ce0b02c9f2c9a3a5adf6f9a95b597bca42ac2a8d8e89f");
        assertThat(result).isEqualTo(expected);
    }

    @Test
    public void testCallLibraryWithManyElements() {
        Bytes32 element = Bytes32.fromHexString("0x0cfe3041fb6512c87922e2146c8308b372f3bf967f889e69ad116ce7c7ec00");
        Bytes32[] arr = new Bytes32[128];
        for (int i = 0; i < 128; i++) {
            arr[i] = element;
        }
        Bytes input = Bytes.concatenate(arr);
        Bytes32 result = Bytes32.wrap(LibIpaMultipoint.commit(input.toArray()));
        Bytes32 expected = Bytes32.fromHexString("0x1b8a1c8c25323f9a58d9221b521f9618e78bb253866de6a3d1c16398678dfa26");
        assertThat(result).isEqualTo(expected);
    }

    @Test
    public void testCallLibraryWithMaxElements() {
        Bytes32 element = Bytes32.fromHexString("0xd36f20567f74f607d9252186ff8efed04de4578d1ddb3de4fe6c5e4249e0045b");
        Bytes32[] arr = new Bytes32[256];
        for (int i = 0; i < 256; i++) {
            arr[i] = element;
        }
        Bytes input = Bytes.concatenate(arr);
        Bytes32 result = Bytes32.wrap(LibIpaMultipoint.commit(input.toArray()));
        Bytes32 expected = Bytes32.fromHexString("0x069e4460d5dd6b48cfcb0a3338a84bc6e38fe686c9d9035017570c3fa10471d6");
        assertThat(result).isEqualTo(expected);
    }

    @Test
    public void testCallLibraryPedersenHash() {
        // Example of passing address and trieIndex to pedersenHash.
        Bytes32 address = Bytes32.fromHexString("0xed3f9549040250ec5cdef31947e5213edee80ad2d5bba35c9e48246c5d9213d6");
        Bytes32 trieIndex = Bytes32.fromHexString("0x1C4C6CE0115457AC1AB82968749EB86ED2D984743D609647AE88299989F91271");
        byte[] total = Bytes.wrap(address, trieIndex).toArray();
        Bytes result = Bytes.of(LibIpaMultipoint.pedersenHash(total));
        assertThat(result).isEqualTo(Bytes32.fromHexString("0x2e50716b7d8c6d13d6005ea248f63f5a11ed63318cad38010f4bcb9a9c2e8b43"));
    }

    @Test
    public void testCallLibraryPedersenCommitment() {
                String[] Frs = {
                        "12893195647771395811699951507158597214664424940649011701135597074831545065572",
                        "5142893599542602373656276295216018895715173401140617021336262693592841454997",
                        "10048101194046039788700061051360312084066913886790839268685488738138501072290",
                        "6509159510107270410132488689623076603937787145758952532530957976566979018526",
                        "4218053922264434878286145096031859410428699791450539652914904444536342603519",
                        "4817885337192536893580889994105033948635916945479522974997443371870775265442",
                        "12700774640826926729587945194211829796659702819105459444735987744642569635384",
                        "2534416989521419140159001527386194742160256148836559716980495154971236022043",
                        "3304812000722692897480960646343280555534662124534976778427326500030581681505",
                        "2478089886800690920121122258054428150769531086857935920347336656096683944845",
                        "9828097927585441660142229037709758538733842192166418960799237542646179037265",
                        "3241371844911415182089157490625179118983522171662845555522917913284987298000",
                        "1062333266298549602090306593985318566026393430146752550329004973107327833352",
                        "12714576994066485926971194792572386807833497396652673310309738998621768561285",
                        "7558913088233756777353502110945757302504103378904059002924396308299974406133",
                        "12501558037310443769038329214990943122261476531521805519107865257048059430148",
                        "3165981467430116453082267551349272590759429776292516484810031836529507242581",
                        "2142082662641343642939009140506036856039246715475067461215149105927597401892",
                        "925456255267296432478333337100084771468314495304472665047432148702150970710",
                        "1127251552775428898363136209812974188204900794254560344244021893876264636608",
                        "10921797792765040804533604613913154605868859382644859563711733544225837678321",
                        "8098444634516585233849884795465908361049134611938340564030810461423319757546",
                        "6593284649264747654202052745463168832684165516019671616833940675413470357016",
                        "10604233578716236184362088385036501552566706533555913238087019691942897760838",
                        "8962834564480178766042346704302816762727591620596928729375080033409273340897",
                        "4771642822527689112704476319586512148608885496718154787136974526312955120523",
                        "2478385689119821839610584127534018174842370687968907067371644133896019288527",
                        "6025472311694966559046455616632043256039461649384000945043286866192762263965",
                        "10266250608784947522647565411039445323146803231059027422805159352906328104868",
                        "6235907730003856259719396227941086027061785699970465044013871504392361711543",
                        "612116858301522364490715899655025758228271195134655325144276873611269249887",
                        "3259495993492463138514421174287186831728266915600152772006700145132854859136",
                        "3673444652761637186797032801221813544156525383756137010988214465626692776969",
                        "3076975027019252493285794773786511694893333513337058672335807039365762176212",
                        "690988353428436762178368834347223647961030194439924437495301179577489295174",
                        "12043791781075321111842298403628664924151292989358593235458333553012406281058",
                        "7731400279002616029632883586916506894982297346283068470698174118075543479475",
                        "775139800865916551447087737156451916254312526192544917583514897399560391374",
                        "9284791386846558668896003270192181750406558215311252015374033831837673696315",
                        "11814124806105136876899608047096716245060162883585694116803765671181297415115",
                        "7369328722076878340951398737204111779425283257150583963697815827315952950666",
                        "9607131043669571444949934819697789485903755583444784706246935569033627313339",
                        "7448758317539725722199394010513821696506542974199041026035638694742047885541",
                        "7545092859093966712895098789271456011024149765125278356616534817838615146606",
                        "11528003327435148568907248200309498627000453376245597230991931477223904757544",
                        "3207925479795221463160190033766581901882078228964250763652835082853006564127",
                        "8571449026941734423219126389635579763618813308968379888413966494668565284294",
                        "2298295937074310707904325527979504569269483204290517298339939441908277809392",
                        "2893609353469276052874154456630317669447446965145559147817995390784747403216",
                        "10208589773135987542025251179995733364231885661841171814121123209889014816454",
                        "495595853636198473891240431477578369268691492870546657677233118996051796433",
                        "6648876838709302339235953881001034615263121071527881082427505518177976692090",
                        "4062095126700285562231632937600756417132543464250825955718609536964182966229",
                        "6648988747251564304799476943415503767374210412840488050165085408376554810052",
                        "105555890227947207822644285106117369504152076268097537656151278222841301194",
                        "4818876792357084487652326970106812678989415825727298510464329617820340683807",
                        "630779252513776744411742339134786858975766299811507422820426388775797741641",
                        "11790660158815036407884782192902339430951233822144595239158692402791189310049",
                        "11965786243798576882659005071678279269792476263485041180425270548545549253394",
                        "5649263656410270722628341096390262310846253529625745369956844629913631331964",
                        "1373632191161871206608337810269760575293720592467573027169294061520192547850",
                        "12129385601134305178259675047870088638962986645172775804428600150072116185454",
                        "11929480785616132939580013994734953008659995851057940458562168038198074971376",
                        "8424109577428777900230434526000878271007719683351852161419937977051056223530",
                        "7758475447477476885389995074382663657052272046038051747790285199823031079154",
                        "1095115031232314628307869391065481441306356929395536930828484236421581998652",
                        "178313000239857334602958170493254209075423932459699097650735468632139790539",
                        "2615664929164580051178469727994556739525393827966638658586157541100119720105",
                        "3655424487281269794049074460188229858440315999714111045721337041072974565082",
                        "11716052722444739157787802428887445492765040459893466324851288450093974386176",
                        "10879675263593203986989027294810816458278702874571667477331092131209475755416",
                        "10213806970250721088128709897653787262479673908915814068563866387043368875164",
                        "376473206716129645561904362317168634000218489046423827839032112113660319053",
                        "6194493399388413958663174240231631530665825348853745027769775899736328461359",
                        "1085535531643665998972042737410563284412495604048207224179326548152684822893",
                        "10097999270273940853723901428239656303168718474554600461294936164141294149438",
                        "847784203483471375211102341856117193032743549174237334127471078119401385807",
                        "551440257124708632902528020602666621459551822536995974294014236599229611717",
                        "12109851686213956031084059394971548575636092399406327141738252645406130450959",
                        "5295724305650384480205444705604211851527309498148859821577183377310181674423",
                        "4978571665403312025495328099911400440922191031144885944265530500893560948007",
                        "824725323721817913939170586375369547494180380208364712600109528432393285177",
                        "1865395059492746087167306204392867309838745567657044175263096026670471958450",
                        "5874576885018377378147580102863128112427196300059612986304503232530437122596",
                        "10996789905734791278472424036201917701758677907986857595209625143920179376799",
                        "1595495883866010171892680264483576192768151041471171359488689338713141409196",
                        "4925796656902162339049917635040650131371092712252256984014122886295059783175",
                        "12771693623569060051131837436030710650128044133573525470005256391754666531855",
                        "10559352180534714773503166076143995328689140021187988791053459391443863730378",
                        "5667153345142145123816794086377435713392506244788911089399000753852228769425",
                        "8869446350189957447868019506697707759591026465213600247423473212325918137373",
                        "3298147973125497812185968665538750915085914277774105467708569373003079354381",
                        "9975141340590245216475820268474706992737007931926580944899892629707244420336",
                        "2726789665470532072508778000899100027612904062097750876332859434735345170851",
                        "12069527890891509040341672515538690594082874369350405764049757958533932059986",
                        "12016660719461473465346151699819234720674051138730565486213087115041778185275",
                        "6981207727477659210570391427969816160537371284926742756808424543663822141169",
                        "252599447203073057830026987976812417015879592586698341973725978864387207428",
                        "4886431872879575351387612502424906852307216021832616094534026554076316085805",
                        "8658997355167539490013230593634206532697635000677267075920776436033811879757",
                        "7759769781831338040038546848167157404250245296663802715444752322548171990274",
                        "11794943548503239236579124424486426925598614545312792527120257495424176859766",
                        "2227990407990851442477979559491292057640328341815678970447482856480462233389",
                        "6823103280365076970289738824259537829146588992823500720237332796416287704891",
                        "3460133463093550925311032364028108462797868705547538173351886512985481176621",
                        "8716337357652589018988750305453022933395054276808687725159303594031939811382",
                        "2406986096350514154236626182144110983374107062976051385765313020057098483735",
                        "4985713772484370128698291891352540150752085760582916977720466129806222041869",
                        "1876818268338883908856580364258065021602010204057089182017139713059776055376",
                        "6052748124749229711322974848791665055859884423244342988352466108830475996108",
                        "5690002874843559865120779195879211489968838048101834176429286840804779411054",
                        "10681351940386210815927388550897189128774483950028494375932438116001626429239",
                        "4632505077722959386674412482688807862624163597066370466890539594175294037530",
                        "4190891699024793387363139429929871828736730227832403360650056572003158298826",
                        "861037143430103903184386903752016763240430626003714630326841095893855530256",
                        "3141430126117628750873149856126629228764806846971209927136891197471768173917",
                        "10329376531283211355831147833589450749877893499072253128409229473840017886335",
                        "6012460377296426093764031205806432489808130880690421318636329755728625265328",
                        "2669966201493100929034156458594552525306350493835487039003069289797059935547",
                        "4032035953130457081718628194103023632388738238498959863832145281409726366991",
                        "10677706130816553889295598572238715224483338382515259956525640574795604987249",
                        "9087179921800376353156188894118672661789229053025726527215340306181594663332",
                        "1468793628960226270207628914229194472827548429490794906146279822347010144530",
                        "4791052467982635585873611348335651344925801780579054187630784235193765503588",
                        "6179291870442163311401545410374816798689314231111054022746959210802485383325",
                        "7526291875120042401672830941045250120070706222004673155349147231240591129669",
                        "9703432289069447826416159229231447217314727256467220404438459931321733332755",
                        "5594526833535306793619953336726740851776732252150658602333695729463725459462",
                        "11387240776034245134402974622400960571978926242035975186507280669153896707660",
                        "10073032863927102305748720114882677146795454146666114362265061834239649566707",
                        "1181463268797474897189014417767839467943706934897445034616213829858989760221",
                        "2663266948892654009683421543378737563256674130930921007071514838898134756492",
                        "591882454457225148120943371021209442968675165838446785871247376076106291352",
                        "4791601180653222798208552183749255017690476268856925593451038178617633635316",
                        "10379088491724349261203945928397958972018966881368907934325304568888896558507",
                        "5991285097569225767598372079137898706665590459942213056783224523878324116798",
                        "12181800895618019443997899859750515139672034790952599670614806326427326139422",
                        "10833773759098230683826371839216153281958674594878927447237809107313339083369",
                        "2163194942043968452281703777926885076906685292330126717418178794569707962805",
                        "269001527075956785597351116486504633122631501194068203301233059953243025174",
                        "10345762692176877988811147167805166887613624223074255736609423401167948503496",
                        "5621121385239827876783958432026292682643186899449774231729807079182582404010",
                        "3447047451657964023981872090138908017744282231640313215526377285278731966574",
                        "6355675393301155669388623646033476721400726573784531682470484092814173525247",
                        "9334428616180239709987251414053482958294608649698100976952097096291118118895",
                        "7080810346674310690687664532944266872439993463974059252702796827738184738938",
                        "433508495432114922623032678990781653351661203568943508828163123722308574169",
                        "710019160965897429786386925315383527601229388101106808036579246212177196364",
                        "8557994119737131196738989510813527965705994021856533905584965316935202385088",
                        "2601211281616545340483137825464905754683648840178969506632282102995897141401",
                        "1309358461127391426287557026960633950769107208212639288784341767679811612013",
                        "59036085993653680649285433813967196296438980949366223408505657181832709261",
                        "6992359991434060223874553903672890915518460464852732478524273173624028375670",
                        "5086386733328529668588799481549834659406691915771006913052425103689280671276",
                        "1838800330959591476644039528315936115901075754882361417661136097900103656856",
                        "11859489907713976885558048934319440335243190910345224912090665350857376566062",
                        "3377853042833471716203056877374016255631909785168156735872984714602647229337",
                        "5865067691600984662210413809588840494501984309383083251748913936732062916244",
                        "9761965154258695179624858222923976371545887868556365242900857860952535604894",
                        "7550997060083038893400677517236257865651792410523965462096508419851276913774",
                        "11799587414996511540838404998866661325587933706028037210168836909813885002909",
                        "8032697420899905903685794096481816123549625891161978232094800126965398351741",
                        "10427746899987934764462037877275713388711565722657100927619900991669437335276",
                        "6906617276312541695258091343393673011770862193316073684482138998827015057858",
                        "5128770914619751144989329481477467147678360480104447378973376755243269369681",
                        "8678719333253475497805926330058206180512030638518436823862296204066137541719",
                        "8792866345531677858042900394265358983712931605414923044576101776488324109045",
                        "11088119744983289594014645071733850074285234961531085687906202877203492487890",
                        "3921449148427966517283852703455465735985749514481516438008990422864932066309",
                        "8212939283835062658746320304015441799660256633124632034790228491490352339297",
                        "1056259386525318012537646239845993156502635540020524466393463213114411453957",
                        "2400938680838865967929099223324261504235176461491033357964486233635044270198",
                        "7793056478596084806971806564904706279280648903340669004996360802229971999005",
                        "9301659020477747128572506231771595902245640659201326287249444363280602498220",
                        "2263293871001176430869803898932156614004067643815357449045313006430809654157",
                        "1668583508936133240053463442199848723046705125505002711688240108574218817588",
                        "4116076749934532818921323405588059629059232279566058746979738750809607499896",
                        "13034507765398801709342084758317328619559855889950007187295332799882649422241",
                        "8759245142403383315445120931975751624770674169379493394045239547372390608071",
                        "5497403571604911036037039339513445017149147081901323110869500241848280702996",
                        "12503358617856597894819764793078068674349493799522464006347850571006332170919",
                        "2583155300024336428634579997980932690926732811831380480069680874093141810095",
                        "3302022453555717855098318801552189032341303365226507057839920095951853371687",
                        "11578278039705323281362142428002645981210753537226151635790245206292153852065",
                        "12504957320236202700576805432265863887677265244103402827924485325206970183419",
                        "8997682435786879914260206834106538481923118404692453293412957808015317990559",
                        "4923395920238807519222600798826531687091886809917013648773879998604735545758",
                        "1660844223072508345059429683662239697630024802639486820446633597702380490033",
                        "7981622788109261446933210940568718083851188077839800242090552025542705900884",
                        "7189893530435398038910028009636989542321504863136439481503224508446498842102",
                        "3221700091970515856812454441410898261324997100716933068442833202799609412905",
                        "6517686250318150440180035075189077184390561645806828359237474587280376729462",
                        "2198649419912555203011289393515559722135022150353165480770625055423791366435",
                        "9391988466230835862492237402211159181673409805965358463330979863871060241454",
                        "54077479904616123751888034012806765062757150009868514300113283299904410536",
                        "12807992404193845605230668867243136664071961646085608259863328399018536256685",
                        "5662932143939320864669662399009331541419545654158293093744622569494918396345",
                        "949162313338583599199902230521935167350474442118051849852937669624334347063",
                        "11404816329996663905342685195398360056647173276478133362387792862574665008206",
                        "8070763012419623985965228112113022712274227370293351190218403258221435435965",
                        "4130486753315632168676893650945946181843390335979106316400995213849037039111",
                        "3636799658641135698015610685999335447019960243627676431996330054969204581303",
                        "118344527005580179353272608992055854664385573792762008884255719910562283454",
                        "3685351746799011852939919845647315370819798850219080359828917097263580229224",
                        "3950699656715692095978490958575769708509159460595940013830702074628548798932",
                        "3992011732808029758210123126030959676638328364014564318101521222986038766085",
                        "1355387764771468311388578594957067138841307871004513964982353312498752489869",
                        "1052288711192044874792617644171422116331002581478428446222990111989697635869",
                        "12116446032378430703134323327521668750787927465213287050364206628892195989988",
                        "2517753617599794067336839668861353071751867692385526566350587617409615463469",
                        "1386739251405679131302581436759161759324701954900357896153902979080114524234",
                        "535380515302816115163757670687019041270400451924313813872172698127700156657",
                        "7070069800748719139501415211328901843445688725949465160213270951038362337316",
                        "2161438559771183099302244999576622640789119978607033314793897583598655811691",
                        "4654161866463046590781885676800930690933766966683292851199271780489401166052",
                        "12405827469050559122045906574103388388432562997193911179428964065906051153522",
                        "8645697982318671985230083008457491032232580476165334017852924517027817008538",
                        "5716558069438635962514961909564238785488187026323524964890895621795139829265",
                        "3776773138502650329164757120752585493597905564074402326505612943737890168883",
                        "10926029816104879443747282989274877429103129665371471462902056607290480887463",
                        "10678716738730598829113102363348476559037593338521229646915698163432379729498",
                        "742293736007574358590677634385215456166399361635438167476166930766363405788",
                        "10966812976710031171847774864315137532395221648141708078017055294757598337671",
                        "5931427360839524080497595423104983752443692867958086203063292709149412412860",
                        "1688200970083949688472322472248562377202822861373198194362457115366394920848",
                        "9917612172105853897038486505886676756599648408247857141183628150964064431966",
                        "3939385480314019506390246318419648176417942793909561632552348934311125055351",
                        "6016255772532193691077824716633961621947200302415470181661215362617417731968",
                        "5364536500523317548696767614260780911727703270914525837219283661348332731520",
                        "9564920704249742558018598671051464722117763307852916363051827255050567345493",
                        "8760876194952856851942489734410756666148609075683803871316886407538029439393",
                        "9193729436206516005737023782521713027774747781639133297314249131754515792678",
                        "8804649572000875419477032731397920581014146631485981628608332551860221483525",
                        "3223289071079869798174888188342828503877705479386280952107874617450911888214",
                        "6210792609934244514917782634709654573352417717872622791219474359884122001176",
                        "9798010429392953548594993125866386198593362661738917378910808625623680549695",
                        "605779152454430965742009275844806024859748953043104095998453723611548248084",
                        "10299387883185059938283925914129936190848891199038823673008642941541114751931",
                        "3469645677755284010576379227827407247311285333483040185037697366983097848867",
                        "5863880927799432778741395474776159114655592947489204611995482295449318532178",
                        "9512979383107784185496953564859933633177324095103842615132411371077978460901",
                        "8266312367043564362025273785794346200181849484675448696234488433816874700541",
                        "10276236826187760441970624202119203620307504894628729446845667809499003394916",
                        "3669098697446307105385902301413490915057429070465850970676508289877075591886",
                        "11134505087876633339792985145310623960229660303407506559571483806911419440640",
                        "12285342242793569309512519218917106123731002865156212611250050527256426638690",
                        "10313997805418783675870735735099063385886627863713525166465369645504882746949",
                        "1631650841536378612009004165152533520263308480484449782757612897814490075715",
                        "2833929667698944878074779360653080731131297180120035741034949873655964519083",
                        "8852444073191111608825766121112054840146085090164508725905219182461101198905",
                        "7165041649933975380698490911160539637620512426099238482538991209566309623001",
                        "7572385432460729226725887206592819985242729179522351603172298555208961301676",
                        "1030804535252827326300304649397384165705239982539462285208069329069347166247",
                        "1067374208043299012338186030851351165738190928328533758641941931072452821680",
                        "9740067923900993470991413046663740497215828394772030063984135614467471441719",
                        "423280507774398882865995446233766231985025391423683323655050630435229339773"
                };

                List<Bytes> FrBytes = new ArrayList<>();
                // We need to pad hex with zeros to fit 32bytes so we can process each scalar as 32 bytes.
                for (int i = 0 ; i < 256; i++ ) {
                    BigInteger decimalBigInt = new BigInteger(Frs[i]);
                    String hexString = decimalBigInt.toString(16);
                    int paddingLength = 64 - hexString.length();

                    if (paddingLength > 0) {
                        StringBuilder paddedHexString = new StringBuilder(hexString);
                        for (int j = 0; j < paddingLength; j++) {
                            paddedHexString.insert(0, '0');
                        }
                        hexString = paddedHexString.toString();
                    }
                    Bytes BytesforConcat = Bytes32.fromHexString(hexString);
                    FrBytes.add(BytesforConcat);
                }
                Bytes input = Bytes.concatenate(FrBytes);

        Bytes32 result = Bytes32.wrap(LibIpaMultipoint.commit(input.toArray()));
        Bytes32 expected = Bytes32.fromHexString("0xC27D008B031859B0342AC8EBE9A11BA1E456ED3C266B708EBAF42A5BD94B43");
        assertThat(result).isEqualTo(expected);
    }
}
